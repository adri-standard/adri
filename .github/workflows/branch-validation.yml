name: Branch Validation - Issue-First Development

on:
  push:
    branches-ignore: [main, develop, master]  # Skip main branches

jobs:
  validate-branch:
    name: Validate Issue-First Branch Name
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Validate branch naming convention
        run: |
          BRANCH="${{ github.ref_name }}"
          
          echo "ğŸ” Validating branch name: $BRANCH"
          echo "Required format: type/issue-{number}-description"
          
          # Required format: type/issue-{number}-description
          if [[ ! "$BRANCH" =~ ^(feat|fix|docs|chore|enhance|hotfix|refactor|test|style|perf)/issue-[0-9]+-.*$ ]]; then
            echo ""
            echo "âŒ BRANCH REJECTED: Invalid naming convention"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Required format: type/issue-{number}-description"
            echo ""
            echo "ğŸ“‹ Valid types:"
            echo "  â€¢ feat      - New features"
            echo "  â€¢ fix       - Bug fixes"
            echo "  â€¢ docs      - Documentation changes"
            echo "  â€¢ enhance   - Enhancements to existing features"
            echo "  â€¢ hotfix    - Emergency fixes"
            echo "  â€¢ refactor  - Code refactoring"
            echo "  â€¢ test      - Test additions or modifications"
            echo "  â€¢ chore     - Maintenance tasks"
            echo "  â€¢ style     - Code style changes"
            echo "  â€¢ perf      - Performance improvements"
            echo ""
            echo "ğŸ¯ Examples:"
            echo "  â€¢ feat/issue-123-user-authentication"
            echo "  â€¢ fix/issue-456-memory-leak"
            echo "  â€¢ docs/issue-789-api-documentation"
            echo "  â€¢ enhance/issue-321-performance-improvement"
            echo ""
            echo "ğŸ“ Current branch: $BRANCH"
            echo ""
            echo "ğŸ”§ To fix this:"
            echo "1. Create a GitHub issue for your work: https://github.com/adri-standard/adri/issues/new/choose"
            echo "2. Rename your branch: git branch -m type/issue-{number}-description"
            echo "3. Push again: git push -u origin HEAD"
            echo ""
            echo "â„¹ï¸  Need help? See: https://github.com/adri-standard/adri/blob/main/CONTRIBUTING.md"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          fi
          
          # Extract issue number for validation
          ISSUE_NUM=$(echo "$BRANCH" | grep -o 'issue-[0-9]\+' | grep -o '[0-9]\+')
          
          echo "âœ… Branch name follows issue-first convention"
          echo "ğŸ“‹ Linked to issue #$ISSUE_NUM"
          echo "ğŸ¯ Branch type: $(echo "$BRANCH" | cut -d'/' -f1)"

      - name: Add helpful comment for successful validation
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            const issueNum = branch.match(/issue-(\d+)/)?.[1];
            
            if (issueNum) {
              console.log(`âœ… Branch ${branch} correctly links to issue #${issueNum}`);
              console.log('ğŸš€ Issue-first development validated - proceeding with CI pipeline');
            }

  # This job provides clear feedback but doesn't block other CI
  validation-summary:
    name: âœ… Issue-First Validation Complete
    if: always()
    needs: [validate-branch]
    runs-on: ubuntu-latest
    timeout-minutes: 1

    steps:
      - name: Report validation status
        run: |
          echo "ğŸ“Š Branch Validation Results:"
          echo "Branch Naming: ${{ needs.validate-branch.result }}"
          
          if [[ "${{ needs.validate-branch.result }}" != "success" ]]; then
            echo ""
            echo "âŒ Issue-first development validation failed"
            echo "ğŸ”„ This branch cannot proceed until naming is corrected"
            echo ""
            echo "ğŸ’¡ Quick fix: Rename branch to include issue number"
            echo "   Example: git branch -m feat/issue-123-your-feature"
            exit 1
          fi
          
          echo ""
          echo "âœ… Issue-first development validated!"
          echo "ğŸš€ Proceeding with standard CI pipeline"
